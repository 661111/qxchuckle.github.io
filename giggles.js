const CACHE_NAME="Chuckle",VERSION_CACHE_NAME="ChuckleTime",MAX_ACCESS_CACHE_TIME=518400;function time(){return(new Date).getTime()}const dbHelper={read:e=>new Promise((t=>{caches.match(e).then((function(e){e||t(null),e.text().then((e=>t(e)))})).catch((()=>{t(null)}))})),write:(e,t)=>new Promise(((n,s)=>{caches.open("ChuckleTime").then((function(s){s.put(e,new Response(t)),n()})).catch((()=>{s()}))})),delete:e=>{caches.match(e).then((t=>{t&&caches.open("ChuckleTime").then((t=>t.delete(e)))}))}},dbTime={read:e=>dbHelper.read(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`)),write:(e,t)=>dbHelper.write(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`),t),delete:e=>dbHelper.delete(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`))},dbAccess={update:e=>dbHelper.write(new Request(`https://ACCESS-CACHE/${encodeURIComponent(e)}`),time()),check:async e=>{const t=new Request(`https://ACCESS-CACHE/${encodeURIComponent(e)}`),n=await dbHelper.read(t);return!!n&&(dbHelper.delete(t),time()-n<518400)}};self.addEventListener("install",(()=>self.skipWaiting()));const cacheList={tianli:{url:/(^(https:\/\/cdn1\.tianli0\.top).*)/g,url:/(^(https:\/\/cdn1\.tianli0\.top)).*\.(css|html|webp|png|jpg|gif|ico|js|woff2|woff|ttf|json|svg)$/g,time:432e3,clean:!0},lf3:{url:/(^(https:\/\/lf3-cdn-tos\.bytecdntp\.com)).*\.(css|html|webp|png|jpg|gif|ico|js|woff2|woff|ttf|json|svg)$/g,time:259200,clean:!0},lf26:{url:/(^(https:\/\/lf26-cdn-tos\.bytecdntp\.com)).*\.(css|html|webp|png|jpg|gif|ico|js|woff2|woff|ttf|json|svg)$/g,time:259200,clean:!0},chuckle:{url:/(^(https:\/\/(www\.chuckle\.top|chuckle\.top|blog\.chuckle\.top)).*)/g,time:172800,clean:!0},localhost:{url:/(^(http:\/\/localhost:4000).*)/g,time:172800,clean:!0}},replaceList={};function findCache(e){for(let t in cacheList){const n=cacheList[t];if(e.match(n.url))return n}return null}function replaceRequest(e){let t=e.url,n=!1;for(let e in replaceList){const s=replaceList[e];for(let e of s.source)t.match(e)&&(t=t.replace(e,s.dist),n=!0)}return n?new Request(t):null}function blockRequest(e){return!1}async function fetchEvent(e,t,n){const s=time();dbAccess.update(e.url);const c=n.time;let r=!1;if(t){const n=await dbTime.read(e.url);if(n){if(s-n<c)return t}r=!0}const i=()=>fetch(e).then((t=>{if(dbTime.write(e.url,s),t.ok||0===t.status){const n=t.clone();caches.open("Chuckle").then((t=>t.put(e,n)))}return t}));if(!r)return i();return Promise.race([new Promise((e=>setTimeout((()=>e(t)),400))),i()]).catch((t=>console.error("不可达的链接："+e.url+"\n错误信息："+t)))}self.addEventListener("fetch",(async e=>{const t=replaceRequest(e.request),n=null===t?e.request:t,s=findCache(n.url);blockRequest(n)?e.respondWith(new Response(null,{status:204})):null!==s?e.respondWith(caches.match(n).then((async e=>fetchEvent(n,e,s)))):null!==t&&e.respondWith(fetch(n))})),self.addEventListener("message",(function(e){"refresh"===e.data&&caches.open("Chuckle").then((function(t){t.keys().then((function(n){for(let e of n){const n=findCache(e.url);null!=n&&!n.clean&&dbAccess.check(e.url)||(t.delete(e),dbTime.delete(e))}e.source.postMessage("success")}))}))}));const cdn={gh:{jsdelivr:"https://cdn1.tianli0.top/gh",fastly:"https://fastly.jsdelivr.net/gh",gcore:"https://gcore.jsdelivr.net/gh",tianli:"https://cdn1.tianli0.top/gh",ravi:"https://cdn.ravi.cool/gh",pai:"https://jsdelivr.pai233.top/gh"},combine:{jsdelivr:"https://cdn1.tianli0.top/combine",fastly:"https://fastly.jsdelivr.net/combine",gcore:"https://gcore.jsdelivr.net/combine",tianli:"https://cdn1.tianli0.top/combine"},npm:{jsdelivr:"https://cdn1.tianli0.top/npm",fastly:"https://fastly.jsdelivr.net/npm",gcore:"https://gcore.jsdelivr.net/npm",tianli:"https://cdn1.tianli0.top/npm",eleme:"https://npm.elemecdn.com",pai:"https://jsdelivr.pai233.top/npm",onm:"https://jsd.onmicrosoft.cn/npm",unpkg:"https://unpkg.com",zhimg:"https://unpkg.zhimg.com",arcitcgn:"https://adn.arcitcgn.cn"}};async function progress(e){return new Response(await e.arrayBuffer(),{status:e.status,headers:e.headers})}function handleRequest(e){const t=[],n=e.url;let s=new URL(n);const c=s.pathname.split("/")[1];for(const e in cdn)if(e===c)for(const n in cdn[e]){const r=cdn[e][n]+s.pathname.replace("/"+c,"");t.push(r)}if(t.length)return fetchAny(t);throw new Error("failure")}function createPromiseAny(){Promise.any=function(e){return new Promise(((t,n)=>{let s=(e=Array.isArray(e)?e:[]).length,c=[];if(0===s)return n(new AggregateError("All promises were rejected"));e.forEach((e=>{e instanceof Promise?e.then((e=>t(e)),(e=>{s--,c.push(e),0===s&&n(new AggregateError(c))})):n(e)}))}))}}function fetchAny(e){const t=new AbortController,n=t.signal,s=e.map((e=>new Promise(((s,c)=>{fetch(e,{signal:n}).then(progress).then((e=>{const n=e.clone();200!==n.status&&c(null),t.abort(),s(n)})).catch((()=>c(null)))}))));return Promise.any||createPromiseAny(),Promise.any(s).then((e=>e)).catch((()=>null))}self.addEventListener("install",(async()=>{await self.skipWaiting()})),self.addEventListener("activate",(async()=>{await self.clients.claim()})),self.addEventListener("fetch",(async e=>{try{const t=navigator,{saveData:n,effectiveType:s}=t.connection||t.mozConnection||t.webkitConnection||{};if(n||/2g/.test(s))return;e.respondWith(handleRequest(e.request))}catch(e){}}));